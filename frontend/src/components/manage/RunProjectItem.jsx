import styles from "./RunProjectItem.module.css";
import document from "../../assets/documentIcon.png";
import log from "../../assets/logIcon.png";
import FrameworkImg from "../common/FrameworkImg";
import toast from "react-hot-toast";
import LogMadal from "../modal/LogModal";

import { getDockerFile, getLog } from "../../api/Docker";
import { stopService } from "../../api/Project";
import { startService } from "../../api/Project";
import { useNavigate } from "react-router-dom";

import useProjectStore from "../../stores/projectStore";
import useModalStore from "../../stores/modalStore";
import RunButton from "./RunButton";
import StopButton from "./StopButton";
import { useState } from "react";

export default function RunProjectItem({ container, type, setContent }) {
  const { selectedProject } = useProjectStore();
  const { checkProceed } = useProjectStore();
  const { setLoadingModal } = useModalStore();
  const { setAction } = useModalStore();
  const { setFileType } = useModalStore();
  const { modalOpen, setModalOpen } = useModalStore();

  const [ log, setLog ] = useState("");

  const navigate = useNavigate();

  //도커파일 조회
  const handleDockerFileModal = async (projectId, serviceId, type) => {
    try {
      const response = await getDockerFile(projectId, serviceId, type);
      if (response.status === 200) {
        setModalOpen(true);
        setFileType("dockerFile");
        setContent(response.data);
      } else {
        toast.error(`도커 파일 조회 실패`, {
          position: "top-center",
        });
      }
    } catch (error) {
      console.log("docker File 조회 실패: " + error);
    }
  };

  //개별 서비스 중지
  const handleStopService = async (containerName) => {
    try {
      if (checkProceed[containerName] === "Running :)") {
        setAction("stop");
        setLoadingModal(true);
        await stopService(containerName).then(() => setLoadingModal(false));
        window.location.replace("/manage");
      } else {
        toast.error(`이미 중지된 컨테이너 입니다. `, {
          position: "top-center",
        });
      }
    } catch (error) {
      console.log("개별중지 실패: " + error);
    }
  };

  //개별 서비스 실행
  const handleStartService = async (containerName) => {
    try {
      setAction("run");
      setLoadingModal(true);
      const response = await startService(containerName).then(() =>
        setLoadingModal(false)
      );
      window.location.replace("/manage");
      if (response.data.status === "SUCCESS") {
      } else {
        toast.error(`개별 실행에 실패하였습니다. `, {
          position: "top-center",
        });
      }
    } catch (error) {
      console.log("개별실행 실패: " + error);
    }
  };

  // 로그 보기
  const handleLogModal = async (serviceId) => {
    try {
      const response = await getLog(serviceId);
      if (response.data.status === "SUCCESS") {
        setModalOpen(true);
        setLog(response.data.data);
      } else {
        toast.error("로그 조회 실패", {
          position: "top-center",
        });
      }
    } catch (error) {
      console.log("로그 조회 실패: " + error);
    }
  };

  const handleIntoContainer = () => {
    if (type === "Backend") {
      navigate(`/manage/backend/${container.serviceId}`);
    } else if (type === "Frontend") {
      navigate(`/manage/frontend`);
    } else {
      navigate(`/manage/database/${container.databaseId}`);
    }
  };

  return (
    <>
      <div className={styles.container}>
        <div className={styles.containerButton}>
          <div className={styles.runButton}>
            <RunButton
              type={type}
              container={container}
              isRunning={
                checkProceed[container.serviceId || container.databaseId]
              }
              handleStartService={handleStartService}
            />

            <StopButton
              type={type}
              container={container}
              handleStopService={handleStopService}
            />
          </div>
          {(type === "Backend" || type === "Frontend") && (
            <div
              className={styles.fileButton}
              onClick={() =>
                handleDockerFileModal(
                  selectedProject.projectId,
                  container.serviceId,
                  type
                )
              }
            >
              Dockerfile 파일 조회
              <img
                src={document}
                alt=""
                decoding="async"
                className={styles.btnIcon}
              />
            </div>
          )}
        </div>
        <div className={styles.box} onClick={() => handleIntoContainer()}>
          <div className={styles.boxTop}>
            <table>
              <tbody>
                <tr>
                  <td key={type} className={styles.serviceName}>
                    {type}
                  </td>
                  <td key={container.externalPort}>
                    외부포트 {container.externalPort}
                  </td>
                </tr>
                <tr>
                  {type === "Backend" || type === "Frontend" ? (
                    <td key={container.framework}>{container.framework}</td>
                  ) : (
                    <td key={container.databaseType}>
                      {container.databaseType}
                    </td>
                  )}

                  <td key={container.internalPort}>
                    내부포트 {container.internalPort}
                  </td>
                </tr>
              </tbody>
            </table>
            <FrameworkImg
              framework={container.framework}
              databaseType={container.databaseType}
            />
          </div>
          <div className={styles.line}></div>
          <div className={styles.boxBottom}>
            <div
              className={
                checkProceed[container.serviceId || container.databaseId] ===
                "Running :)"
                  ? styles.running
                  : styles.stopped
              }
            >
              {checkProceed[container.serviceId || container.databaseId]}
            </div>
            <div className={styles.log} onClick={() =>
                handleLogModal(container.serviceId)
              }>
              <img
                src={log}
                alt=""
                decoding="async"
                className={styles.btnIcon}
              />
              로그 보기
            </div>
          </div>
        </div>
      </div>
      {modalOpen && <LogMadal content={log}/>}
    </>
  );
}
